---
title: "Pipeline_4T1-scRNA-Parsev3DropSeq-Integrated"
author: "Ian Schrack"
date: "2025-01-13"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r Clear variable list}
# Clear all variables from the workspace to prevent conflicts with old objects.
rm(list = ls())

# Set the seed for consistency
set.seed(42); 
```

```{r, include=FALSE}
# Please install the correct version of seurat
remotes::install_version("Seurat", version = "5.1.0")
```


## Part I: Import & load necessary libraries and data
This section loads all required packages for the analysis. The libraries support various functions including single-cell analysis (Seurat, monocle3), data manipulation (dplyr, reshape2), visualization (ggplot2, ComplexHeatmap, ggrepel), enrichment analysis (clusterProfiler), and additional utilities. Ensure that all packages are installed before running this code.
```{r Load libraries, include=FALSE}
library(Seurat)               # Single-cell RNA-seq analysis
library(dplyr)                # Data manipulation
library(Matrix)               # Matrix operations for large datasets
library(ggplot2)              # Data visualization
library(SeuratDisk)           # Converting Seurat objects between formats
library(scales)               # Scaling functions for visualization
library(usethis)              # Workflow automation and package management
library(CellChat)             # Cell-cell communication analysis
library(ComplexHeatmap)       # Advanced heatmap visualization (used with CellChat)
library(clusterProfiler)      # Enrichment analysis and visualization
library(plotrix)              # Additional plotting utilities
library(Hmisc)                # Miscellaneous functions for data analysis
library(reshape2)             # Data reshaping
library(monocle3)             # Trajectory analysis for single-cell data
library(SeuratWrappers)       # Additional wrappers for Seurat functionalities
library(RColorBrewer)         # Color palettes for graphics
library(ggpubr)               # Publication-ready ggplot2 themes and functions
library(ggbeeswarm)           # Beeswarm plots for data distribution
library("clusterProfiler")    # (Duplicate) Enrichment analysis; ensure version consistency
library("org.Mm.eg.db")       # Mouse genome annotations
library("AnnotationHub")      # Access to a variety of genomic resources
library(ggrepel)              # Improved label placement for ggplot2
library(UCell)                # Gene set scoring in single cells
library(SCpubr)               # Enhancements for single-cell visualizations
library(msigdbr)              # Gene sets from the Molecular Signatures Database (MSigDB)
```

```{r Load pre-made data, echo=TRUE, message=FALSE, warning=FALSE}
# Load the pre-integrated data generated from the Harmony integration pipeline.
# Ensure that the pipeline 'HarmonyIntegration-4T1-scRNA-Parsev3DropSeq.Rmd' has been executed prior to this step.
# Specify the file path to the pre-integrated R object.

AllTissue <- readRDS("/Users/ianschrack/Desktop/10882-IS/ParseDropSeqHarmonyMerge_PreAnnotate.rds")

# Backup file: 
# '/Users/ianschrack/University of Michigan Dropbox/ENGIN-Shea Lab/Ian Schrack (TT)/Research/Manuscripts/3-4T1_Neutrophils/Data/ParseDropSeqHarmonyDatasetIntegrate_PreAnnotate.rds'
```

## Part II: Combined Tissue Object QC, Clustering, and Annotation
### Pre-filtered Dataset QC Metrics & Visualizations
In this section, we prepare and visualize quality control metrics for the pre-filtered dataset. We re-order the time point metadata, calculate the percentage of mitochondrial gene expression per cell, and generate scatter and violin plots to assess the distribution of key QC metrics (number of genes, total counts, and mitochondrial percentage) across time points and tissues. This allows us to evaluate cell quality before further analysis.
```{r Pre-filtered QC metrics & visualizations, message=FALSE, warning=FALSE}
# Re-order 'Day' factor to ensure correct chronological order in plots.
AllTissue@meta.data$Day <- factor(x = AllTissue@meta.data$Day, levels = c("D0", "D7", "D14", "D21"))

# Notes on QC metrics:
# - nFeature_RNA: Number of genes detected per cell.
# - nCount_RNA: Total RNA counts per cell.
# - percent.mt: Percentage of mitochondrial gene expression, indicating cell quality.

# Calculate the percentage of mitochondrial gene expression for each cell.
AllTissue[["percent.mt"]] <- PercentageFeatureSet(AllTissue, pattern = "^mt-")

# Visualize relationships between QC metrics using scatter plots.
FeatureScatter(AllTissue, feature1 = "nCount_RNA", feature2 = "percent.mt", group.by = "dataset")
FeatureScatter(AllTissue, feature1 = "nCount_RNA", feature2 = "nFeature_RNA", group.by = "dataset")

# Generate violin plots for QC metrics grouped by day.
VlnPlot(AllTissue, pt.size = 0, features = "nFeature_RNA", group.by = "Day") + ggtitle("All nFeature_RNA")
VlnPlot(AllTissue, pt.size = 0, features = "nCount_RNA", group.by = "Day") + ggtitle("All nCount_RNA")
VlnPlot(AllTissue, pt.size = 0, features = "percent.mt", group.by = "Day") + ggtitle("All percent.mt")

# Generate violin plots for QC metrics grouped by tissue.
VlnPlot(AllTissue, pt.size = 0, features = "nFeature_RNA", group.by = "Tissue") + ggtitle("All nFeature_RNA")
VlnPlot(AllTissue, pt.size = 0, features = "nCount_RNA", group.by = "Tissue") + ggtitle("All nCount_RNA")
VlnPlot(AllTissue, pt.size = 0, features = "percent.mt", group.by = "Tissue") + ggtitle("All percent.mt")

# Subset and visualize QC metrics for specific tissues.
## For Lung tissue:
temp <- subset(AllTissue, subset = Tissue == "Lung")
VlnPlot(temp, pt.size = 0, features = "nFeature_RNA", group.by = "Day") + ggtitle("Lung nFeature_RNA")
VlnPlot(temp, pt.size = 0, features = "nCount_RNA", group.by = "Day") + ggtitle("Lung nCount_RNA")
VlnPlot(temp, pt.size = 0, features = "percent.mt", group.by = "Day") + ggtitle("Lung percent.mt")

## For Scaffold tissue:
temp <- subset(AllTissue, subset = Tissue == "Scaffold")
VlnPlot(temp, pt.size = 0, features = "nFeature_RNA", group.by = "Day") + ggtitle("Scaffold nFeature_RNA")
VlnPlot(temp, pt.size = 0, features = "nCount_RNA", group.by = "Day") + ggtitle("Scaffold nCount_RNA")
VlnPlot(temp, pt.size = 0, features = "percent.mt", group.by = "Day") + ggtitle("Scaffold percent.mt")

## For Blood tissue:
temp <- subset(AllTissue, subset = Tissue == "Blood")
VlnPlot(temp, pt.size = 0, features = "nFeature_RNA", group.by = "Day") + ggtitle("Blood nFeature_RNA")
VlnPlot(temp, pt.size = 0, features = "nCount_RNA", group.by = "Day") + ggtitle("Blood nCount_RNA")
VlnPlot(temp, pt.size = 0, features = "percent.mt", group.by = "Day") + ggtitle("Blood percent.mt")

# Remove temporary variable to clean up the workspace.
rm(temp)
```

In this section, we summarize the cell counts for each tissue type (Lung, Scaffold, and Blood) by replicate and day. For each tissue, we subset the data, create a contingency table of cell counts, add margins to show row and column totals, and print the results. Finally, we remove the temporary variable to clean up the workspace.
```{r Pre-filtered cell count by tissue/day/replicate}
# Summarize cell counts for Lung tissue.
print("Lung Pre-Filter")
temp <- subset(AllTissue, subset = Tissue == "Lung")
addmargins(table(temp@meta.data$Replicate, temp@meta.data$Day))

# Summarize cell counts for Scaffold tissue.
print("Scaffold Pre-Filter")
temp <- subset(AllTissue, subset = Tissue == "Scaffold")
addmargins(table(temp@meta.data$Replicate, temp@meta.data$Day))

# Summarize cell counts for Blood tissue.
print("Blood Pre-Filter")
temp <- subset(AllTissue, subset = Tissue == "Blood")
addmargins(table(temp@meta.data$Replicate, temp@meta.data$Day))

# Clean up temporary variable.
rm(temp)
```
### Filter Cells
In this section, we filter out low-quality cells by applying thresholds to key QC metrics. Although Seurat’s default filtering criteria are typically nFeature_RNA > 200 & nFeature_RNA < 2500 & percent.mt < 5, the thresholds here have been adjusted for our dataset: we retain cells with fewer than 5000 detected genes, less than 20000 total RNA counts, and under 15% mitochondrial gene expression.
```{r Filter cells, echo=FALSE}
# Filter cells based on adjusted QC thresholds:
# - nFeature_RNA < 5000: Exclude cells with excessively high gene counts.
# - nCount_RNA < 20000: Exclude cells with very high total RNA counts.
# - percent.mt < 15: Exclude cells with high mitochondrial gene expression, which may indicate poor quality.
AllTissue <- subset(AllTissue, subset = nFeature_RNA < 5000 & nCount_RNA < 20000 & percent.mt < 15)
```


### Post-filtered dataset QC 
```{r Post-filtered QC metrics & visualizations}
# Post-Filtering
FeatureScatter(AllTissue, feature1 = "nCount_RNA", feature2 = "percent.mt")
FeatureScatter(AllTissue, feature1 = "nCount_RNA", feature2 = "nFeature_RNA")

# Features split by day 
VlnPlot(AllTissue, pt.size = 0, features = "nFeature_RNA", group.by = "Day") + ggtitle("All nFeature_RNA")
VlnPlot(AllTissue, pt.size = 0, features = "nCount_RNA", group.by = "Day") + ggtitle("All nCount_RNA")
VlnPlot(AllTissue, pt.size = 0, features = "percent.mt", group.by = "Day") + ggtitle("All percent.mt")

# Features split by tissue 
VlnPlot(AllTissue, pt.size = 0, features = "nFeature_RNA", group.by = "Tissue") + ggtitle("All nFeature_RNA")
VlnPlot(AllTissue, pt.size = 0, features = "nCount_RNA", group.by = "Tissue") + ggtitle("All nCount_RNA")
VlnPlot(AllTissue, pt.size = 0, features = "percent.mt", group.by = "Tissue") + ggtitle("All percent.mt")

# Subset just lung
temp <- subset(AllTissue, subset = Tissue == "Lung")
VlnPlot(temp, pt.size = 0, features = "nFeature_RNA", group.by = "Day") + ggtitle("Lung nFeature_RNA")
VlnPlot(temp, pt.size = 0, features = "nCount_RNA", group.by = "Day") + ggtitle("Lung nCount_RNA")
VlnPlot(temp, pt.size = 0, features = "percent.mt", group.by = "Day") + ggtitle("Lung percent.mt")

# Subset just scaffold
temp <- subset(AllTissue, subset = Tissue == "Scaffold")
VlnPlot(temp, pt.size = 0, features = "nFeature_RNA", group.by = "Day") + ggtitle("Scaffold nFeature_RNA")
VlnPlot(temp, pt.size = 0, features = "nCount_RNA", group.by = "Day") + ggtitle("Scaffold nCount_RNA")
VlnPlot(temp, pt.size = 0, features = "percent.mt", group.by = "Day") + ggtitle("Scaffold percent.mt")

# Subset just lung
temp <- subset(AllTissue, subset = Tissue == "Blood")
VlnPlot(temp, pt.size = 0, features = "nFeature_RNA", group.by = "Day") + ggtitle("Blood nFeature_RNA")
VlnPlot(temp, pt.size = 0, features = "nCount_RNA", group.by = "Day") + ggtitle("Blood nCount_RNA")
VlnPlot(temp, pt.size = 0, features = "percent.mt", group.by = "Day") + ggtitle("Blood percent.mt")

rm(temp)
```

In this section, we summarize the cell counts for each tissue type (Lung, Scaffold, and Blood) after filtering. For each tissue, we subset the data, generate a contingency table of cell counts by replicate and day (with added margins for totals), and print the results. Finally, we remove the temporary variable to clean up the workspace.
```{r Post-filtered cell count by tissue/day/replicate, message=FALSE, warning=FALSE}
# Summarize post-filter cell counts for Lung tissue.
print("Lung Post-Filter")
temp <- subset(AllTissue, subset = Tissue == "Lung")
addmargins(table(temp@meta.data$Replicate, temp@meta.data$Day))

# Summarize post-filter cell counts for Scaffold tissue.
print("Scaffold Post-Filter")
temp <- subset(AllTissue, subset = Tissue == "Scaffold")
addmargins(table(temp@meta.data$Replicate, temp@meta.data$Day))

# Summarize post-filter cell counts for Blood tissue.
print("Blood Post-Filter")
temp <- subset(AllTissue, subset = Tissue == "Blood")
addmargins(table(temp@meta.data$Replicate, temp@meta.data$Day))

# Remove temporary variable to clean up workspace.
rm(temp)
```

```{r Normalization/Scaling/Dimensionality Reduction, include=FALSE  }
# Normalize the data using log normalization.
AllTissue <- NormalizeData(AllTissue, normalization.method = "LogNormalize", scale.factor = 10000)

# Identify 2000 variable features using the 'vst' method.
AllTissue <- FindVariableFeatures(AllTissue, selection.method = "vst", nfeatures = 2000)

# Scale the data.
AllTissue <- ScaleData(AllTissue, features = VariableFeatures(object = AllTissue))

# Linear dimensional reduction
AllTissue <- RunPCA(AllTissue, features = VariableFeatures(object = AllTissue))

# Elbow plot to estimate dimensions
ElbowPlot(AllTissue, ndims = 50)
```


### Clustering & Dimensionality Reduction
In this section, we use the Harmony reduction to perform clustering and UMAP dimensionality reduction. We use the first 40 dimensions for the analysis, then clean up by removing the temporary variable.
```{r Clustering & dimensional reduction, include=FALSE}
# Define the number of dimensions to use for analysis.
dims = 40

# Build a nearest-neighbor graph using the first 'dims' dimensions from the Harmony reduction.
AllTissue <- FindNeighbors(AllTissue, reduction = "harmony", dims = 1:dims, verbose = FALSE)

# Cluster cells using the graph; here we set resolution to 1 with specified clustering parameters.
AllTissue <- FindClusters(AllTissue, resolution = 1, verbose = FALSE, algorithm = 2, method = "igraph")

# Run UMAP for dimensionality reduction using the first 'dims' dimensions.
AllTissue <- RunUMAP(AllTissue, dims = 1:dims, reduction = "harmony", verbose = FALSE, min.dist = 0.5, spread = 0.5)

# Remove the temporary variable 'dims' from the workspace.
rm(dims)
```

### Combined Tissue Object UMAP Visualizations
```{r UMAP visualizations, message=FALSE, warning=FALSE}
# UMAP plot with cluster labels.
DimPlot(AllTissue, reduction = "umap", label = TRUE)

# UMAP plot colored by both tissue type and cluster assignment.
DimPlot(AllTissue, reduction = "umap", group.by = c("Tissue", "seurat_clusters"))

# UMAP plot split by tissue type for side-by-side comparisons, with labels.
DimPlot(AllTissue, reduction = "umap", split.by = "Tissue", label = TRUE)
```

### Differential Gene Expression (Finding Cluster Markers)

In this section, we identify differentially expressed genes (markers) for each cell cluster. First, we rejoin the RNA assay layers using JoinLayers to ensure a unified dataset. Then, we use Seurat’s FindAllMarkers function to detect markers that are expressed in at least 25% of cells and have a minimum log fold-change of 0.25. Finally, we extract the top two markers per cluster based on the average log2 fold-change.
```{r Differential gene expression, message=FALSE, warning=FALSE}
# Rejoin RNA assay layers to ensure the dataset is unified before differential expression analysis.
AllTissue <- JoinLayers(AllTissue)

# Identify differentially expressed genes (cluster markers).
# - min.pct = 0.25: Only genes expressed in at least 25% of cells are considered.
# - logfc.threshold = 0.25: Only genes with a log fold-change above 0.25 are retained.
AllTissue_markers <- FindAllMarkers(AllTissue, min.pct = 0.25, logfc.threshold = 0.25)

# For each cluster, extract the top 2 markers based on the highest average log2 fold-change.
AllTissue_markers %>% 
  group_by(cluster) %>% 
  top_n(n = 2, wt = avg_log2FC)
```

### Rename Clusters & Filter Unknowns

In this section, we rename cell clusters using Seurat’s RenameIdents function to assign biologically meaningful names. We then create a metadata slot for cell types, remove cells labeled as “Unknown”, reorder the factor levels for consistent visualization, and set the active identity to the defined cell types.
```{r Rename cell clusters with meaningful }
# Rename cell clusters with meaningful names.
AllTissue <- RenameIdents(AllTissue, "0" = "Monocyte")         # Cluster 0: Monocyte (previously Myeloid)
AllTissue <- RenameIdents(AllTissue, "1" = "Neutrophils")
AllTissue <- RenameIdents(AllTissue, "2" = "Neutrophils")
AllTissue <- RenameIdents(AllTissue, "3" = "B Cells")
AllTissue <- RenameIdents(AllTissue, "4" = "Macrophage")
AllTissue <- RenameIdents(AllTissue, "5" = "Monocyte")
AllTissue <- RenameIdents(AllTissue, "6" = "Macrophage")
AllTissue <- RenameIdents(AllTissue, "7" = "Neutrophils")
AllTissue <- RenameIdents(AllTissue, "8" = "NK Cells")
AllTissue <- RenameIdents(AllTissue, "9" = "T Cells")
AllTissue <- RenameIdents(AllTissue, "10" = "ECs")
AllTissue <- RenameIdents(AllTissue, "11" = "T Cells")
AllTissue <- RenameIdents(AllTissue, "12" = "T Cells")
AllTissue <- RenameIdents(AllTissue, "13" = "Eosinophils")
AllTissue <- RenameIdents(AllTissue, "14" = "DC")
AllTissue <- RenameIdents(AllTissue, "15" = "Fibroblasts")
AllTissue <- RenameIdents(AllTissue, "16" = "pDC")
AllTissue <- RenameIdents(AllTissue, "17" = "T Cells")
AllTissue <- RenameIdents(AllTissue, "18" = "Neutrophils")
AllTissue <- RenameIdents(AllTissue, "19" = "Monocyte")
AllTissue <- RenameIdents(AllTissue, "20" = "Prolif_Monocyte")
AllTissue <- RenameIdents(AllTissue, "21" = "Basophils")
AllTissue <- RenameIdents(AllTissue, "22" = "Neutrophils")
AllTissue <- RenameIdents(AllTissue, "23" = "Monocyte")         # Cluster 23: Monocyte (previously Myeloid)
AllTissue <- RenameIdents(AllTissue, "24" = "Unknown")
AllTissue <- RenameIdents(AllTissue, "25" = "Unknown")
AllTissue <- RenameIdents(AllTissue, "26" = "B Cells")
AllTissue <- RenameIdents(AllTissue, "27" = "Unknown")

# Create a new metadata slot 'CellType' from the current cluster identities.
AllTissue@meta.data$CellType <- Idents(AllTissue)

# Filter out cells labeled as 'Unknown' to retain only defined cell types.
AllTissue <- subset(AllTissue, subset = CellType %in% 
                      c("Neutrophils", "Monocyte", "Prolif_Monocyte", "Macrophage", 
                        "DC", "pDC", "Basophils", "Eosinophils", "B Cells", 
                        "T Cells", "NK Cells", "ECs", "Fibroblasts"))

# Reorder 'CellType' factor levels for consistent visualization.
AllTissue@meta.data$CellType <- factor(AllTissue@meta.data$CellType, 
                                       levels = c("Neutrophils", "Monocyte", "Prolif_Monocyte", "Macrophage", 
                                                  "DC", "pDC", "Basophils", "Eosinophils", "B Cells", 
                                                  "T Cells", "NK Cells", "ECs", "Fibroblasts"))

# Reorder the 'Day' factor to ensure chronological order.
AllTissue$Day <- factor(AllTissue$Day, levels = c("D0", "D7", "D14", "D21"))

# Set the active identity of the Seurat object to the 'CellType' metadata.
Idents(AllTissue) <- factor(AllTissue@meta.data$CellType)
```



### Dotplot of Cluster-Defining Genes
In this section, we create a dot plot to visualize the expression of selected marker genes across cell clusters. The cell.genes vector contains key genes defining various cell populations. The plot is customized with a specific color gradient and theme modifications for enhanced readability. After plotting, we remove the cell.genes object from the workspace.

```{r Dotplot of cluster-defining genes}
# Define a vector of marker genes for key cell populations.
cell.genes <- c("Ptprc", "Itgam", "Fn1", "Fcgr3",
                "S100a8", "S100a9", "Csf3r", "Il1r2", "Il1b",
                "Ly6c", "Cd68", 
                "Psap", "Apoe", "Apobec1", "Csf1r",
                "Mki67", "Top2a",
                "Htr7", "Flt3", "H2-Ab1", "H2-Aa",
                "Siglech", "Bst2", "Klk1", 
                "Gata2", "Cpa3", "Ms4a2", "Itga2b", 
                "Siglecf", "Ear1", "Ear2", 
                "Cd19", "Pax5",
                "Ccr7", "Cd3e", "Cd3g", "Itk", "Tox", "Cd28", 
                "Egfl7", "Flt1", "Kdr", 
                "Col1a1", "Col3a1", "Col1a2")

# Create a dot plot to visualize marker gene expression across clusters.
# Note: Adjust the plot size (WxH: 1000 x 450 pixels) in your output settings if needed.
DotPlot(AllTissue, features = cell.genes, 
        col.min = -1, col.max = 1) + 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) + 
  scale_colour_gradient2(low = muted("blue"), mid = "white", high = muted("red"), 
                         midpoint = 0, limits = c(-2, 2), oob = scales::squish) + 
  theme(
    panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "gray"), # Style major grid lines
    panel.grid.minor = element_blank(),  # Hide minor grid lines
    panel.background = element_blank(),  # Remove background for a cleaner look
    panel.border = element_rect(colour = "black", fill = NA, size = 1), # Add a border around the plot
    legend.position = "none",              # Hide the legend
    axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1) # Ensure x-axis labels are angled for clarity
  ) + 
  ylab("") + 
  xlab("")

# Remove the marker gene vector to clean up the workspace.
rm(cell.genes)

```



### Count Table per Tissue by Cell Type & Day
This section generates count tables displaying the distribution of cell types by day for the post-filtered dataset. First, it prints the combined cell counts for all tissues, then subsets the data by tissue (Lung, Scaffold, Blood, and Spleen) to print individual tables with row and column totals using addmargins().

```{r Count table per tissue by cell type & day, message=FALSE, warning=FALSE}
# Combined cell counts across all tissues organized by cell type and day.
print("Combined Tissue Post-Filter")
addmargins(table(AllTissue@meta.data$CellType, AllTissue@meta.data$Day))

# Cell counts for Lung tissue.
print("Lung Post-Filter")
temp <- subset(AllTissue, subset = Tissue == "Lung")
addmargins(table(temp@meta.data$CellType, temp@meta.data$Day))

# Cell counts for Scaffold tissue.
print("Scaffold Post-Filter")
temp <- subset(AllTissue, subset = Tissue == "Scaffold")
addmargins(table(temp@meta.data$CellType, temp@meta.data$Day))

# Cell counts for Blood tissue.
print("Blood Post-Filter")
temp <- subset(AllTissue, subset = Tissue == "Blood")
addmargins(table(temp@meta.data$CellType, temp@meta.data$Day))

# Cell counts for Spleen tissue.
print("Spleen Post-Filter")
temp <- subset(AllTissue, subset = Tissue == "Spleen")
addmargins(table(temp@meta.data$CellType, temp@meta.data$Day))

# Clean up temporary variable.
rm(temp)
```



### AllTissue Cell Cycle Scoring
In this section, we score cells based on their cell cycle phases using pre-defined S and G2M gene sets. We then visualize the S and G2M scores on the UMAP embedding with a custom color gradient. Finally, we reset the active identity to the defined cell types.

```{r AllTissue Cell cycle scoring, warning=FALSE, message=FALSE}
# Score cell cycle phases using the predefined gene sets for S and G2M phases.
AllTissue <- CellCycleScoring(AllTissue, 
                              g2m.features = cc.genes$g2m.genes, 
                              s.features = cc.genes$s.genes, 
                              set.ident = TRUE)

# Visualize the S phase score on the UMAP with a color gradient from light grey to blue.
FeaturePlot(AllTissue, features = "S.Score", reduction = "umap") +
  scale_color_gradientn(colours = c('lightgrey', 'blue'), limits = c(0, 1))

# Visualize the G2M phase score on the UMAP with a similar color gradient.
FeaturePlot(AllTissue, features = "G2M.Score", reduction = "umap") +
  scale_color_gradientn(colours = c('lightgrey', 'blue'), limits = c(0, 1))

# Reset the active identity to the 'CellType' metadata.
AllTissue <- SetIdent(AllTissue, value = AllTissue@meta.data$CellType)
```



## Part III: Neutrophils Subsetting, Scaling, & Dimensional Reduction
In this section, we extract the neutrophil subset from the integrated dataset, identify variable features, scale the data, run PCA, build a neighbor graph, cluster the cells, and generate a UMAP embedding. We also adjust parallel processing settings to speed up calculations.

```{r Neutrophils: Pre-processing, message=FALSE, warning=FALSE, include=FALSE}
# Subset the neutrophils from the integrated dataset.
Neuts <- subset(AllTissue, subset = CellType %in% c("Neutrophils"))

# Identify variable features using the VST method (top 2000 genes).
Neuts <- FindVariableFeatures(Neuts, selection.method = "vst", nfeatures = 2000)

# Identify and visualize the 10 most highly variable genes.
top10 <- head(VariableFeatures(Neuts), 10)
VariableFeaturePlot(Neuts)
rm(top10)

# Store all gene names for downstream analysis.
all.genes_Neuts <- data.frame(rownames(Neuts))

# Adjust settings for efficient parallel processing.
options(future.globals.maxSize = 8000 * 1024^2)
future::plan("multisession", workers = 8)

# Scale the data.
Neuts <- ScaleData(Neuts)

# Run PCA on the variable features.
Neuts <- RunPCA(Neuts, features = VariableFeatures(object = Neuts))

# Build a neighbor graph using the Harmony reduction over the first 30 dimensions.
Neuts <- FindNeighbors(Neuts, dims = 1:30, reduction = "harmony")

# Cluster the cells with a resolution of 0.4.
Neuts <- FindClusters(Neuts, resolution = 0.4, algorithm = 1, verbose = TRUE)

# Generate a UMAP embedding using the first 30 dimensions with custom parameters.
Neuts <- RunUMAP(Neuts, dims = 1:30, reduction = "harmony", min.dist = 0.4, spread = 0.5, n.neighbors = 5)
```



### Neutrophil UMAP Visualizations by Grouping
This section generates UMAP plots for the neutrophil subset using different grouping variables. Each plot emphasizes a different aspect of the data (clusters, tissue, day, and dataset) to facilitate exploratory analysis.

```{r Neutrophil UMAP visualizations, warning=FALSE, message=FALSE}
# UMAP plot with cluster labels (ideal plot size: 500 x 450).
DimPlot(Neuts, reduction = "umap", label = TRUE)

# UMAP plot colored by Tissue type (ideal plot size: 1200 x 400).
DimPlot(Neuts, reduction = "umap", group.by = "Tissue")

# UMAP plot colored by Day (ideal plot size: 1200 x 400).
DimPlot(Neuts, reduction = "umap", group.by = "Day")

# UMAP plot colored by dataset (ideal plot size: 500 x 450).
DimPlot(Neuts, reduction = "umap", group.by = "dataset")
```



Neutrophil Marker Dotplot & UMAP Visualizations Pre-Annotation
In this section, we generate a dot plot to display the expression of selected marker genes used for cluster annotation. The plot uses a customized color gradient and theme adjustments for clarity.

Marker genes were derived from the following publication:
Grieshaber-Bouyer, R., Radtke, F.A., Cunin, P. et al. The neutrotime transcriptional signature defines a single continuum of neutrophils across biological compartments. Nat Commun 12, 2856 (2021). https://doi.org/10.1038/s41467-021-22973-9


```{r Neutrophil Marker Dotplot & UMAP Visualizations Pre-Annotation, warning=FALSE, message=FALSE}
# Define marker genes in reversed order for plotting.
Neut_features <- rev(c(
  "Rps27", "Ptma", "Hmgb1", "Cebpe", "H2afz", "Tubb5", "Ube2c", "Stmn1", "Calm2", "Tuba1b", 
  "Gm5483", "Hmgn2", "Hmgb2", "Serpinb1a", "Dstn", "Arhgdib", "Ngp", "Pglyrp1", "Cybb", "Cd177",  
  "Lyz2", "Ifitm6", "Anxa1", "Camp", "Lcn2", "Ltf", "Ly6c2", "Ly6g",                             
  "Prdx5", "Lgals3", "Prr13", "Mmp9", "Mgst1", "mt-Co1", "Mmp8", "Retnlg", "S100a6",               
  "Wfdc17", "Ifitm2", "Ifitm1", "Il1b", "Btg1", "Fxyd5", "Srgn", "Malat1",                         
  "Dusp1", "Jund", "Fth1", "Ccl6", "Msrb1", "Csf3r", "Junb", "H2-D1"                               
))

# Generate a dot plot for the selected marker genes.
DotPlot(Neuts, features = Neut_features) + 
  scale_colour_gradient2(low = muted("blue"), mid = "white", high = muted("red"), 
                         midpoint = 0, limits = c(-2, 2), oob = scales::squish) +  
  theme(
    axis.text.x = element_text(size = 12, angle = 45, hjust = 1, colour = "black"), # x-axis text
    panel.grid.major = element_line(size = 0.5, linetype = "solid", colour = "gray"),  # Major grid lines
    panel.grid.minor = element_blank(),                                                # Remove minor grid lines
    panel.background = element_blank(),                                                  # Transparent background
    panel.border = element_rect(colour = "black", fill = NA, size = 1),                    # Add panel border
    legend.position = "bottom"                                                           # Place legend at the bottom
  )
```



Rename Neutrophil Subclusters & Filter

In this section, we rename neutrophil clusters to their corresponding P0–P4 subcluster labels, set consistent factor orders for CellType, Day, and Tissue, and then filter to retain only the subclusters and tissues of interest. P0 was found to be erythrocytes, so is filtered out. Blood was mostly this P0/erythorocyte cluster, so we filter it out here. 

```{r Rename Neutrophil Subclusters & Filter, warning=FALSE, message=FALSE}
# Rename cluster identities to meaningful subcluster labels.
Neuts <- RenameIdents(Neuts,
  "0" = "P4_2",
  "1" = "P4_1",
  "2" = "P3",
  "3" = "P2",
  "4" = "P1",
  "5" = "P0"
)

# Create a metadata column 'CellType' from the current identities.
Neuts$CellType <- Idents(Neuts)

# Order CellType factor levels for coherent plotting.
Neuts$CellType <- factor(Neuts$CellType,
  levels = c("P0", "P1", "P2", "P3", "P4_1", "P4_2")
)

# Order Day factor levels chronologically.
Neuts$Day <- factor(Neuts$Day,
  levels = c("D0", "D7", "D14", "D21")
)

# Filter to retain only subclusters P1–P4_2.
Neuts <- subset(Neuts, subset = CellType %in% c("P1", "P2", "P3", "P4_1", "P4_2"))
Neuts$CellType <- factor(Neuts$CellType,
  levels = c("P1", "P2", "P3", "P4_1", "P4_2")
)

# Filter to include only Spleen, Lung, and Scaffold tissues and set factor order.
Neuts <- subset(Neuts, subset = Tissue %in% c("Spleen", "Lung", "Scaffold"))
Neuts$Tissue <- factor(Neuts$Tissue,
  levels = c("Spleen", "Lung", "Scaffold")
)
```



Annotated Neutrophil Marker Expression Dotplot

After renaming the neutrophil subclusters (P1–P4), we re-plot the same set of marker genes to visualize their expression across these annotated subclusters. The dot plot uses a diverging color gradient and custom theme adjustments for clarity.

```{r Annotated Neutrophil Marker Expression Dotplot, warning=FALSE, message=FALSE}
# Define marker genes in reversed order for plotting.
Neut_features <- rev(c(
  "Rps27", "Ptma", "Hmgb1", "Cebpe", "H2afz", "Tubb5", "Ube2c", "Stmn1", "Calm2", "Tuba1b",   # Purely P0/P1
  "Gm5483", "Hmgn2", "Hmgb2", "Serpinb1a", "Dstn", "Arhgdib", "Ngp", "Pglyrp1", "Cybb", "Cd177",  # Transition P1 -> P2
  "Lyz2", "Ifitm6", "Anxa1", "Camp", "Lcn2", "Ltf", "Ly6c2", "Ly6g",                             # Transition P1 -> P2
  "Prdx5", "Lgals3", "Prr13", "Mmp9", "Mgst1", "mt-Co1", "Mmp8", "Retnlg", "S100a6",               # Transition P2 -> P3
  "Wfdc17", "Ifitm2", "Ifitm1", "Il1b", "Btg1", "Fxyd5", "Srgn", "Malat1",                         # Transition P2 -> P3
  "Dusp1", "Jund", "Fth1", "Ccl6", "Msrb1", "Csf3r", "Junb", "H2-D1"                               # Transition P2 -> P3
))

# Generate a dot plot for the selected marker genes.
DotPlot(Neuts, features = Neut_features) + 
  scale_colour_gradient2(low = muted("blue"), mid = "white", high = muted("red"), 
                         midpoint = 0, limits = c(-2, 2), oob = scales::squish) +  
  theme(
    axis.text.x = element_text(size = 12, angle = 45, hjust = 1, colour = "black"), # x-axis text
    panel.grid.major = element_line(size = 0.5, linetype = "solid", colour = "gray"),  # Major grid lines
    panel.grid.minor = element_blank(),                                                # Remove minor grid lines
    panel.background = element_blank(),                                                  # Transparent background
    panel.border = element_rect(colour = "black", fill = NA, size = 1),                    # Add panel border
    legend.position = "bottom"                                                           # Place legend at the bottom
  )

rm(Neut_features)
```



Neutrophil UMAP Projections Post‑Annotation

In this section, we re-visualize the neutrophil UMAP embedding after assigning annotated subcluster identities. We plot the embedding colored by subcluster, tissue origin, and sampling day, using a consistent point size for clarity.

```{r Neutrophil UMAP Projections Post‑Annotation, warning=FALSE, message=FALSE}
# UMAP plot colored by annotated subclusters (CellType), without labels.
# Use a moderate point size for readability; remove the plot title.
DimPlot(Neuts, reduction = "umap", label = FALSE, pt.size = 0.5) + 
  ggtitle(NULL)

# UMAP plot colored by tissue of origin (Spleen, Lung, Scaffold).
DimPlot(Neuts, reduction = "umap", group.by = "Tissue", pt.size = 0.5) + 
  ggtitle(NULL)

# UMAP plot colored by sampling day (D0–D21).
DimPlot(Neuts, reduction = "umap", group.by = "Day", pt.size = 0.5) + 
  ggtitle(NULL)
```



Neutrophil Subtype Counts Summary

This section computes and displays contingency tables of neutrophil subcluster counts by (1) sampling day, (2) tissue of origin, and (3) biological replicate, including marginal totals for quick overview of distribution.

```{r Neutrophil Subtype Counts Summary, warning=FALSE, message=FALSE}
# Counts of each neutrophil subcluster across sampling days (with row/column totals).
addmargins(table(Neuts@meta.data$CellType, Neuts@meta.data$Day))

# Counts of each neutrophil subcluster by tissue of origin.
addmargins(table(Neuts@meta.data$CellType, Neuts@meta.data$Tissue))

# Counts of each neutrophil subcluster across biological replicates.
addmargins(table(Neuts@meta.data$CellType, Neuts@meta.data$Replicate))
```



Neutrophil Subtype Counts by Tissue & Day

Here we compute and display the counts of each neutrophil subcluster across sampling days for each tissue, including marginal totals to assess distribution.

```{r Neutrophil Subtype Counts by Tissue & Day, warning=FALSE, message=FALSE}
# Lung: counts by subcluster and day
print("Lung: Neutrophil counts by Day")
temp <- subset(Neuts, subset = Tissue == "Lung")
addmargins(table(temp@meta.data$CellType, temp@meta.data$Day))

# Scaffold: counts by subcluster and day
print("Scaffold: Neutrophil counts by Day")
temp <- subset(Neuts, subset = Tissue == "Scaffold")
addmargins(table(temp@meta.data$CellType, temp@meta.data$Day))

# Spleen: counts by subcluster and day
print("Spleen: Neutrophil counts by Day")
temp <- subset(Neuts, subset = Tissue == "Spleen")
addmargins(table(temp@meta.data$CellType, temp@meta.data$Day))

# Clean up temporary variable
rm(temp)
```



Neutrophil Subcluster Proportions by Day and Tissue

This section visualizes the distribution of neutrophil subclusters (P1–P4) over time within each tissue using stacked bar charts, and compares subcluster proportions across tissues with a flipped bar chart.

```{r Neutrophil Subcluster Proportions by Day and Tissue, message=FALSE, warning=FALSE}
# 1. Helper function to plot subcluster percent by day for a given tissue.
plot_subtype_by_day <- function(obj, tissue) {
  # Subset to the specified tissue.
  temp1 <- subset(obj, subset = Tissue == tissue)
  # Create a data frame of counts per Day and CellType.
  temp2 <- data.frame(table(temp1@meta.data$CellType, temp1$Day))
  
  # Rename columns and compute percentages by Day.
  temp2 <- temp2 %>%
    dplyr::rename(CellType = Var1, Day = Var2) %>%
    dplyr::group_by(Day) %>%
    dplyr::mutate(Percent = Freq / sum(Freq) * 100)
  
  # Generate stacked bar chart.
  ggplot(temp2, aes(x = Day, y = Percent, fill = CellType)) +
    geom_bar(stat = "identity", colour = "black") +
    scale_y_continuous(breaks = seq(0, 100, 20), limits = c(0, 100.00001), expand = c(0, 0)) +
    theme(
      text = element_text(size = 20, colour = "black"),
      axis.text.x = element_text(size = 20, colour = "black"),
      axis.text.y = element_text(size = 20, colour = "black"),
      axis.line.x = element_blank(),
      axis.ticks.x = element_blank(),
      axis.line.y = element_line(size = 1, colour = "black", linetype = 1),
      axis.ticks.length.y = unit(0.25, "cm"),
      axis.ticks.y = element_line(size = 1, colour = "black"),
      plot.background = element_rect(fill = "transparent", colour = NA),
      panel.background = element_rect(fill = "transparent", colour = NA)
    )
}

# 2. Generate plots for each tissue with titles.
SB_lung   <- plot_subtype_by_day(Neuts, "Lung")   + ggtitle("Lung")
SB_spleen <- plot_subtype_by_day(Neuts, "Spleen") + ggtitle("Spleen")
SB_scaf   <- plot_subtype_by_day(Neuts, "Scaffold") + ggtitle("Scaffold")

# 3. Combine the three stacked bar charts side-by-side.
SB_spleen + theme(legend.position = "none", axis.title.x = element_blank()) +
  SB_lung +   theme(legend.position = "none", legend.title = element_blank(), axis.title.y = element_blank()) +
  SB_scaf +   theme(axis.title.y = element_blank(), axis.title.x = element_blank(), legend.position = "right")

# Clean up helper function and plot objects.
rm(plot_subtype_by_day, SB_spleen, SB_lung, SB_scaf)


# 4. Prepare data to compare subcluster proportions across tissues.
# Subsample each tissue for equal representation.
t1 <- subset(Neuts, subset = Tissue == "Spleen", downsample = 1000); Idents(t1) <- "tissue"
t2 <- subset(Neuts, subset = Tissue == "Lung", downsample = 1000);   Idents(t2) <- "tissue"
t3 <- subset(Neuts, subset = Tissue == "Scaffold", downsample = 1000); Idents(t3) <- "tissue"

# Merge subsampled objects.
t4 <- merge(t1, list(t2, t3))

# Filter to subclusters P1–P4 only and tabulate counts by Tissue.
temp1 <- subset(t4, subset = CellType %in% c("P1", "P2", "P3", "P4_1", "P4_2"))
temp2 <- data.frame(table(temp1@meta.data$CellType, temp1@meta.data$Tissue))
temp2 <- subset(temp2, Var1 != "P0")  # Exclude P0 if present.

# Rename columns, compute percentages by CellType, and set factor levels.
temp2 <- temp2 %>%
  dplyr::rename(CellType = Var1, Tissue = Var2) %>%
  dplyr::group_by(CellType) %>%
  dplyr::mutate(Percent = Freq / sum(Freq) * 100)
temp2$CellType <- factor(temp2$CellType, levels = c("P1", "P2", "P3", "P4_1", "P4_2"))

# 5. Flipped bar chart: subcluster distribution across tissues.
ggplot(temp2, aes(x = CellType, y = Percent, fill = Tissue)) +
  geom_bar(stat = "identity", colour = "black") +
  coord_flip() +
  scale_y_continuous(breaks = seq(0, 100, 20), limits = c(0, 100.00001), expand = c(0, 0)) +
  scale_fill_manual(values = c("#2CA02C", "#1F77B4", "#9467BD")) +
  labs(x = NULL, y = "Percent", fill = NULL) +
  theme(
    text = element_text(size = 20, colour = "black"),
    axis.text.x = element_text(size = 15, colour = "black"),
    axis.text.y = element_text(size = 20, colour = "black"),
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.line.y = element_line(size = 1, colour = "black", linetype = 1),
    axis.ticks.length.y = unit(0.25, "cm"),
    axis.ticks.y = element_line(size = 1, colour = "black"),
    plot.background = element_rect(fill = "transparent", colour = NA),
    panel.background = element_rect(fill = "transparent", colour = NA),
    legend.position = "top",
    legend.title = element_blank(),
    plot.margin = unit(c(10, 10, 10, 10), "mm")
  )

# Clean up temporary objects.
rm(t1, t2, t3, t4, temp1, temp2)
```

## Part IV: Neutrophil Cell Cycle Scoring


Neutrophil Cell Cycle Scoring & Visualization

In this section, we assign each neutrophil to a cell‐cycle phase using predefined S and G2M gene sets, visualize the resulting S and G2M scores on the UMAP embedding, and then restore the annotated subcluster identities.
```{r Neutrophil Cell Cycle Scoring & Visualization, message=FALSE, warning=FALSE}
# 1. Score cell‐cycle phases
#    - g2m.features: genes expressed during G2/M transition
#    - s.features: genes expressed during S phase
#    - set.ident = TRUE sets the active identity of each cell to its predicted phase
Neuts <- CellCycleScoring(
  Neuts,
  g2m.features = cc.genes$g2m.genes,
  s.features    = cc.genes$s.genes,
  set.ident     = TRUE
)

# 2. Plot S phase scores on UMAP
FeaturePlot(
  Neuts,
  features  = "S.Score",
  reduction = "umap",
  pt.size   = 0.5
) +
  scale_color_gradientn(
    colours = c("lightgrey", "blue"),
    limits  = c(0, 1)
  ) +
  ggtitle("S Score")

# 3. Plot G2M phase scores on UMAP
FeaturePlot(
  Neuts,
  features  = "G2M.Score",
  reduction = "umap",
  pt.size   = 0.5
) +
  scale_color_gradientn(
    colours = c("lightgrey", "blue"),
    limits  = c(0, 1)
  ) +
  ggtitle("G2M Score")

# 4. Restore cell identities to annotated subclusters
Neuts <- SetIdent(Neuts, value = Neuts@meta.data$CellType)
```



Neutrophil Maturation Scoring via CytoTRACE2
############### WARNING: TAKES UP A LOT OF APPLICATION MEMORY ###############
Here, we use CytoTRACE2 to estimate the developmental potential (maturation state) of each neutrophil and prepare the object for downstream visualization.
```{r Neutrophil Maturation Scoring via CytoTRACE2, message=FALSE, warning=FALSE, include=FALSE}
# 1. Load CytoTRACE2 library for developmental potential scoring
library(CytoTRACE2)

# 2. Configure parallelization and memory limits for CytoTRACE2
future::plan("multisession", workers = 16)
options(future.globals.maxSize = 24000 * 1024^2)

# 3. Run CytoTRACE2 on the Seurat object
#    - is_seurat = TRUE tells the function to accept a Seurat object directly
Neuts <- cytotrace2(Neuts, is_seurat = TRUE)

# 4. Reset memory limit for other operations
options(future.globals.maxSize = 8000 * 1024^2)
```


```{r Load/Save Neutrophils}
# saveRDS(Neuts, file = "/Users/ianschrack/Desktop/10882-IS/Neuts.rds")
Neuts <- readRDS("/Users/ianschrack/Desktop/10882-IS/Neuts.rds") # Post cytotrace analysis
```



Neutrophil Maturation: CytoTRACE2 Visualization

This section visualizes CytoTRACE2 outputs to interpret neutrophil differentiation trajectories. It includes:
	1.	A clipped potency score UMAP,
	2.	Potency category UMAP,
	3.	Relative order score UMAP,
	4.	Maturity comparisons across subclusters and tissues.

```{r Neutrophil CytoTRACE2 Plotting, warning=FALSE, message=FALSE}
# ─── Setup ─────────────────────────────────────────────────────────────────────

# Adjust CytoTRACE2's relative score for interpretability:
# Reverse and normalize score so 1 = least mature, 0 = most mature.
Neuts$RevCytoTRACE2_Relative <- -1 * (Neuts$CytoTRACE2_Relative - 1)

# Clear previous plot-related variables.
rm(plot_list, labels, colors, x_limits, y_limits, potency_score_umap, rel_order_umap)

# Define potency category labels and custom color scale (red = mature, blue = stem-like).
labels <- c('Differentiated', 'Unipotent', 'Oligopotent', 'Multipotent', 'Pluripotent', 'Totipotent')
colors <- c("#9E0142", "#F46D43", "#FEE08B", "#E6F598", "#66C2A5", "#5E4FA2")

# Record coordinate range to ensure consistent UMAP plotting limits.
x_limits <- range(Neuts@reductions$umap@cell.embeddings[, 1], na.rm = TRUE)
y_limits <- range(Neuts@reductions$umap@cell.embeddings[, 2], na.rm = TRUE)

# ─── Clipped Potency Score UMAP ────────────────────────────────────────────────

# Invert and clip the raw CytoTRACE2 score (higher score = higher stemness).
Neuts$CytoTRACE2_Score_clipped <- -pmax(pmin(5.5 - 6 * Neuts$CytoTRACE2_Score, 5), 0)

# UMAP colored by clipped potency score.
FeaturePlot(Neuts, "CytoTRACE2_Score_clipped", reduction = "umap", pt.size = 0.5) +
  scale_colour_gradientn(
    colours = rev(colors),
    na.value = "transparent",
    labels = labels,
    limits = c(-5, 0),
    name = "Potency score\n",
    guide = guide_colorbar(frame.colour = "black", ticks.colour = "black")
  ) +
  coord_cartesian(xlim = x_limits, ylim = y_limits) +
  labs(x = "UMAP1", y = "UMAP2", title = NULL) +
  theme(
    aspect.ratio = 1,
    legend.text = element_text(size = 10),
    legend.title = element_text(size = 12),
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 12),
    plot.title = element_text(size = 12, face = "bold", hjust = 0.5, margin = margin(b = 20))
  )

# ─── Potency Category UMAP ─────────────────────────────────────────────────────

# UMAP colored by CytoTRACE2-assigned potency categories.
DimPlot(Neuts, reduction = "umap", group.by = "CytoTRACE2_Potency", label = FALSE, pt.size = 0.5) +
  scale_color_manual(
    values = colors,
    name = "Potency category",
    breaks = rev(labels)
  ) +
  coord_cartesian(xlim = x_limits, ylim = y_limits) +
  labs(x = "UMAP1", y = "UMAP2", title = NULL) +
  theme(
    aspect.ratio = 1,
    legend.text = element_text(size = 10),
    legend.title = element_text(size = 12),
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 12),
    plot.title = element_text(size = 12, face = "bold", hjust = 0.5, margin = margin(b = 20))
  )

# ─── Relative Score UMAP ───────────────────────────────────────────────────────

# UMAP colored by CytoTRACE2's relative score (0 = stem-like, 1 = differentiated).
FeaturePlot(Neuts, "CytoTRACE2_Relative", reduction = "umap", pt.size = 0.5) +
  scale_colour_gradientn(
    colours = c("#000004FF", "#3B0F70FF", "#8C2981FF", "#DE4968FF", "#FE9F6DFF", "#FCFDBFFF"),
    na.value = "transparent",
    limits = c(0, 1),
    breaks = seq(0, 1, by = 0.2),
    labels = c("1.0 (More diff.)", "0.8", "0.6", "0.4", "0.2", "0.0 (Less diff.)"),
    name = "Relative\norder\n",
    guide = guide_colorbar(frame.colour = "black", ticks.colour = "black")
  ) +
  coord_cartesian(xlim = x_limits, ylim = y_limits) +
  labs(x = "UMAP1", y = "UMAP2", title = NULL) +
  theme(
    aspect.ratio = 1,
    legend.text = element_text(size = 10),
    legend.title = element_text(size = 12),
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 12),
    plot.title = element_text(size = 12, face = "bold", hjust = 0.5, margin = margin(b = 20))
  )

# ─── Maturity Score Violin Plots ───────────────────────────────────────────────

# Compare relative maturity across neutrophil subclusters
v1 <- VlnPlot(Neuts, features = "RevCytoTRACE2_Relative", group.by = "CellType", pt.size = 0) +
  geom_boxplot(outlier.shape = NA, width = 0.1, color = "black", fill = "white", alpha = 0.5) +
  labs(x = NULL, y = "Relative Maturity", title = NULL) +
  theme(legend.position = "none")

# Compare across tissues
v2 <- VlnPlot(Neuts, features = "RevCytoTRACE2_Relative", group.by = "Tissue", pt.size = 0) +
  geom_boxplot(outlier.shape = NA, width = 0.1, color = "black", fill = "white", alpha = 0.5) +
  labs(x = NULL, y = NULL, title = NULL) +
  theme(legend.position = "none")

# Combine side-by-side
cowplot::plot_grid(v1, v2, align = "h")

# ─── Clean up ─────────────────────────────────────────────────────────────────

rm(labels, colors, x_limits, y_limits, v1, v2)
```



Neutrophil CytoTRACE2 Potency Counts by Subcluster and Tissue

This chunk summarizes the number of cells assigned to each CytoTRACE2 potency category, stratified by (1) annotated neutrophil subcluster and (2) tissue of origin. Row and column totals are included for easy interpretation of distributions.

```{r Neutrophil CytoTRACE2 Potency Table Summaries, message=FALSE, warning=FALSE}
# Contingency table: potency category × subcluster (CellType)
addmargins(table(Neuts@meta.data$CytoTRACE2_Potency, Neuts@meta.data$CellType))

# Contingency table: potency category × tissue
addmargins(table(Neuts@meta.data$CytoTRACE2_Potency, Neuts@meta.data$Tissue))
```



## PartV: Communication Network Analysis (CellChat)

#### Function to create CellChat objects for lung and scaffold
This section defines a helper function to construct and preprocess CellChat objects from a Seurat object subset by tissue and timepoint. The function performs standard preprocessing, identifies overexpressed genes/interactions, and infers cell–cell communication networks. It is then used to generate and merge CellChat objects for lung and scaffold samples across four timepoints (D0, D7, D14, D21).

```{r Function to create CellChat objects, message=FALSE, warning=FALSE}
# Load mouse-specific ligand-receptor interaction database
CellChatDB <- CellChatDB.mouse
CC_Interactions <- as.data.frame(CellChatDB$interaction)

# ──────────────────────────────────────────────────────────────────────────────
# Function: CreateCellChatObject
# Description: Subsets a Seurat object by tissue and day, then returns a processed CellChat object.
# ──────────────────────────────────────────────────────────────────────────────
CreateCellChatObject <- function(object, tissue, timepoint) {
  # Subset Seurat object to specific tissue and timepoint
  seurat_subset <- subset(object, subset = Tissue == tissue & Day == timepoint)
  
  # Prepare metadata and labels for CellChat
  cell_labels <- Idents(seurat_subset)
  cellchat_meta <- data.frame(labels = cell_labels, row.names = names(cell_labels))
  
  # Initialize CellChat object
  cellchat_obj <- createCellChat(object = seurat_subset, group.by = "ident", assay = "RNA")
  cellchat_obj <- addMeta(cellchat_obj, meta = cellchat_meta)
  cellchat_obj <- setIdent(cellchat_obj, ident.use = "labels")
  cellchat_obj@DB <- CellChatDB  # Set the database
  
  # Preprocess the CellChat object
  future::plan("multisession", workers = 4)
  options(future.globals.maxSize = 8000 * 1024^2)
  cellchat_obj <- subsetData(cellchat_obj)
  cellchat_obj <- identifyOverExpressedGenes(cellchat_obj)
  cellchat_obj <- identifyOverExpressedInteractions(cellchat_obj)
  
  # Run core communication inference and network analysis
  cellchat_obj <- computeCommunProb(cellchat_obj, type = "triMean")
  cellchat_obj <- aggregateNet(cellchat_obj)
  cellchat_obj <- computeCommunProbPathway(cellchat_obj)
  cellchat_obj <- filterCommunication(cellchat_obj, min.cells = 10)
  cellchat_obj <- netAnalysis_computeCentrality(cellchat_obj, slot.name = "netP")
  
  return(cellchat_obj)
}
```


Generate and merge CellChat objects for lung and scaffold

This chunk creates CellChat objects for lung and scaffold tissues at four distinct timepoints (D0, D7, D14, D21) using the previously defined CreateCellChatObject() function. Each object’s intercellular communication network is inferred independently and then merged into a single longitudinal object (lung_merge_cc and scaf_merge_cc, respectively) for downstream comparative analysis.

```{r Generate lung and scaffold CellChat objects, message=FALSE, warning=FALSE, include=FALSE}
# Lung CellChat objects
d0_lung_cc   <- CreateCellChatObject(AllTissue, "Lung", "D0")
d7_lung_cc   <- CreateCellChatObject(AllTissue, "Lung", "D7")
d14_lung_cc  <- CreateCellChatObject(AllTissue, "Lung", "D14")
d21_lung_cc  <- CreateCellChatObject(AllTissue, "Lung", "D21")

# Merge lung CellChat objects into a single longitudinal analysis object
lungcc_object.list <- list(
  d0.lung = d0_lung_cc,
  d7.lung = d7_lung_cc,
  d14.lung = d14_lung_cc,
  d21.lung = d21_lung_cc
)
lung_merge_cc <- mergeCellChat(lungcc_object.list, add.names = names(lungcc_object.list))


# Scaffold CellChat objects
d0_scaf_cc   <- CreateCellChatObject(AllTissue, "Scaffold", "D0")
d7_scaf_cc   <- CreateCellChatObject(AllTissue, "Scaffold", "D7")
d14_scaf_cc  <- CreateCellChatObject(AllTissue, "Scaffold", "D14")
d21_scaf_cc  <- CreateCellChatObject(AllTissue, "Scaffold", "D21")

# Merge scaffold CellChat objects
scafcc_object.list <- list(
  d0.scaf = d0_scaf_cc,
  d7.scaf = d7_scaf_cc,
  d14.scaf = d14_scaf_cc,
  d21.scaf = d21_scaf_cc
)
scaf_merge_cc <- mergeCellChat(scafcc_object.list, add.names = names(scafcc_object.list))

rm(CC_Interactions, CellChatDB)
```

```{r Lung Cellchat plotting}
weight.max <- getMaxWeight(lungcc_object.list, attribute = c("idents","count"))

# Plot size (WxH): 1400 x 700
par(mfrow = c(1,4), xpd=TRUE)
for (i in 1:4) {
  netVisual_circle(lungcc_object.list[[i]]@net$count, 
                 weight.scale = T, label.edge= F, edge.weight.max = weight.max[2], 
                 edge.width.max = 10, arrow.size = 0.05, 
                 title.name = paste0(""))
}
par(mfrow = c(1,1), xpd=TRUE)

rm(weight.max)

# Compare the major sources and targets
num.link <- sapply(lungcc_object.list, function(x) {rowSums(x@net$count) + colSums(x@net$count)-diag(x@net$count)})
weight.MinMax <- c(min(num.link), max(num.link)) # control the dot size in the different datasets

plot_list <- list()

for (i in 1:4){
  plot_list[[i]] <- netAnalysis_signalingRole_scatter(lungcc_object.list[[i]], weight.MinMax = weight.MinMax) + 
    ylim(0, 2.8) + xlim(0, 6) + 
    theme(axis.line = element_line(color = "black", size = 2), 
          axis.text = element_text(color = "black", size = 12), 
          axis.title = element_text(color = "black", size = 12, face = "bold"), 
          plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "cm"), 
          legend.position = "none") + 
  ylim(0, 2.8) + xlim(0, 6)
}

# Plot size (WxH): 1200 x 350
cowplot::plot_grid(plot_list[[1]], plot_list[[2]], plot_list[[3]], plot_list[[4]], align = "h", ncol = 4)

rm(num.link, weight.MinMax, plot_list)
```

```{r Scaffold Cellchat plotting, warning=FALSE, message=FALSE}
weight.max <- getMaxWeight(scafcc_object.list, attribute = c("idents","count"))

# Plot size (WxH): 1400 x 700
par(mfrow = c(1,4), xpd=TRUE)
for (i in 1:4) {
  netVisual_circle(scafcc_object.list[[i]]@net$count, 
                 weight.scale = T, label.edge= F, edge.weight.max = weight.max[2], 
                 edge.width.max = 10, arrow.size = 0.05, 
                 title.name = paste0(""))
}
par(mfrow = c(1,1), xpd=TRUE)

rm(weight.max)

# Compare the major sources and targets
num.link <- sapply(scafcc_object.list, function(x) {rowSums(x@net$count) + colSums(x@net$count)-diag(x@net$count)})
weight.MinMax <- c(min(num.link), max(num.link)) # control the dot size in the different datasets

plot_list <- list()

for (i in 1:4){
  plot_list[[i]] <- netAnalysis_signalingRole_scatter(scafcc_object.list[[i]], weight.MinMax = weight.MinMax) + 
    ylim(0, 2.8) + xlim(0, 6) + 
    theme(axis.line = element_line(color = "black", size = 2), 
          axis.text = element_text(color = "black", size = 12), 
          axis.title = element_text(color = "black", size = 12, face = "bold"), 
          plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "cm"), 
          legend.position = "none") + 
  ylim(0, 2.8) + xlim(0, 6)
}

# Plot size (WxH): 1200 x 350
cowplot::plot_grid(plot_list[[1]], plot_list[[2]], plot_list[[3]], plot_list[[4]], align = "h", ncol = 4)

rm(num.link, weight.MinMax, plot_list)
```

































































































































# Main Body Figures (for Publication)
### 1D, 1E???

### Figure 1F
```{r Stacked barchart of AllTissue by celltype, message=FALSE, warning=FALSE}
# Backup original object
Fallback_AllTissue <- AllTissue

# Helper function: Creates a stacked bar chart for a given tissue.
create_stacked_bar <- function(tissue) {
  # Subset the data for the specified tissue.
  temp <- subset(AllTissue, subset = Tissue == tissue)
  
  # Create a frequency table and convert to a dataframe.
  temp_df <- as.data.frame(table(temp@meta.data$CellType, temp$Day))
  
  # Rename columns and calculate cell type percentages per day.
  temp_df <- temp_df %>%
    dplyr::rename(CellType = Var1, Day = Var2) %>%
    dplyr::group_by(Day) %>%
    dplyr::mutate(Percent = Freq / sum(Freq) * 100)
  
  # Generate the stacked barchart with custom theme settings.
  ggplot(temp_df, aes(x = Day, y = Percent, fill = CellType)) +
    geom_bar(stat = "identity", colour = "black") +
    theme(text = element_text(size = 20, colour = "black"),
          axis.text.x = element_text(size = 20, colour = "black", angle = 45, vjust = 1, hjust = 1),
          axis.text.y = element_text(size = 20, colour = "black"),
          axis.line.x = element_blank(),
          axis.ticks.x = element_blank(),
          axis.line.y = element_line(size = 1, colour = "black", linetype = 1),
          axis.ticks.length.y = unit(0.25, "cm"),
          axis.ticks.y = element_line(size = 1, colour = "black"),
          plot.background = element_rect(fill = "transparent", colour = NA),
          panel.background = element_rect(fill = "transparent", colour = NA)) +
    scale_y_continuous(breaks = seq(0, 100, 20), limits = c(0, 100.00001), expand = c(0, 0)) +
    labs(x = "", y = "")
}

# Create plots for each tissue.
SB_lung   <- create_stacked_bar("Lung")
SB_scaf   <- create_stacked_bar("Scaffold")
SB_spleen <- create_stacked_bar("Spleen")

# Combine plots using patchwork.
library(patchwork)
combined_plot <- (SB_spleen + theme(legend.position = "none", axis.title.x = element_blank())) +
                 (SB_lung   + theme(legend.position = "bottom", legend.title = element_blank(), axis.title.y = element_blank())) +
                 (SB_scaf   + theme(axis.title.y = element_blank(), axis.title.x = element_blank(), legend.position = "none"))

# Display the combined plot.
print(combined_plot)

# Clean up temporary objects.
rm(SB_lung, SB_scaf, SB_spleen, create_stacked_bar, combined_plot)
AllTissue <- Fallback_AllTissue
rm(Fallback_AllTissue)
```

### Figure 2A
```{r Neutrophil UMAP Projections Post‑Annotation by SubCluster, warning=FALSE, message=FALSE}
# UMAP plot colored by annotated subclusters (CellType), without labels.
# Use a moderate point size for readability; remove the plot title.
# Plot size (WxH): 500 x 450
DimPlot(Neuts, reduction = "umap", label = FALSE, pt.size = 0.5) + 
  ggtitle(NULL)
```

### Figure 2B
```{r Neutrophil UMAP Projections Post‑Annotation by Tissue and Day, warning=FALSE, message=FALSE}
# UMAP plot colored by tissue of origin (Spleen, Lung, Scaffold).
# Plot size (WxH): 500 x 450
DimPlot(Neuts, reduction = "umap", group.by = "Tissue", pt.size = 0.5) + 
  ggtitle(NULL)

# UMAP plot colored by sampling day (D0–D21).
# Plot size (WxH): 500 x 450
DimPlot(Neuts, reduction = "umap", group.by = "Day", pt.size = 0.5) + 
  ggtitle(NULL)
```


### Figure 2C
```{r Annotated Neutrophil Marker Expression Dotplot, warning=FALSE, message=FALSE}
# Define marker genes in reversed order for plotting.
Neut_features <- rev(c(
  "Rps27", "Ptma", "Hmgb1", "Cebpe", "H2afz", "Tubb5", "Ube2c", "Stmn1", "Calm2", "Tuba1b",   # Purely P0/P1
  "Gm5483", "Hmgn2", "Hmgb2", "Serpinb1a", "Dstn", "Arhgdib", "Ngp", "Pglyrp1", "Cybb", "Cd177",  # Transition P1 -> P2
  "Lyz2", "Ifitm6", "Anxa1", "Camp", "Lcn2", "Ltf", "Ly6c2", "Ly6g",                             # Transition P1 -> P2
  "Prdx5", "Lgals3", "Prr13", "Mmp9", "Mgst1", "mt-Co1", "Mmp8", "Retnlg", "S100a6",               # Transition P2 -> P3
  "Wfdc17", "Ifitm2", "Ifitm1", "Il1b", "Btg1", "Fxyd5", "Srgn", "Malat1",                         # Transition P2 -> P3
  "Dusp1", "Jund", "Fth1", "Ccl6", "Msrb1", "Csf3r", "Junb", "H2-D1"                               # Transition P2 -> P3
))

# Generate a dot plot for the selected marker genes.
# Plot size (WxH): 1100 x 220 with legend.position = "none" 
DotPlot(Neuts, features = Neut_features) + 
  scale_colour_gradient2(low = muted("blue"), mid = "white", high = muted("red"), 
                         midpoint = 0, limits = c(-2, 2), oob = scales::squish) +  
  theme(
    axis.text.x = element_text(size = 12, angle = 45, hjust = 1, colour = "black"), # x-axis text
    panel.grid.major = element_line(size = 0.5, linetype = "solid", colour = "gray"),  # Major grid lines
    panel.grid.minor = element_blank(),                                                # Remove minor grid lines
    panel.background = element_blank(),                                                  # Transparent background
    panel.border = element_rect(colour = "black", fill = NA, size = 1),                    # Add panel border
    legend.position = "bottom"                                                           # Place legend at the bottom
  ) + ylab("") + xlab("")
```

### Figure 2E
```{r Neutrophil CytoTRACE2 Potency Score UMAP, warning=FALSE, message=FALSE}
# ─── Setup ─────────────────────────────────────────────────────────────────────

# Adjust CytoTRACE2's relative score for interpretability:
# Reverse and normalize score so 1 = least mature, 0 = most mature.
Neuts$RevCytoTRACE2_Relative <- -1 * (Neuts$CytoTRACE2_Relative - 1)

# Define potency category labels and custom color scale (red = mature, blue = stem-like).
labels <- c('Differentiated', 'Unipotent', 'Oligopotent', 'Multipotent', 'Pluripotent', 'Totipotent')
colors <- c("#9E0142", "#F46D43", "#FEE08B", "#E6F598", "#66C2A5", "#5E4FA2")

# Record coordinate range to ensure consistent UMAP plotting limits.
x_limits <- range(Neuts@reductions$umap@cell.embeddings[, 1], na.rm = TRUE)
y_limits <- range(Neuts@reductions$umap@cell.embeddings[, 2], na.rm = TRUE)

# ─── Clipped Potency Score UMAP ────────────────────────────────────────────────

# Invert and clip the raw CytoTRACE2 score (higher score = higher stemness).
Neuts$CytoTRACE2_Score_clipped <- -pmax(pmin(5.5 - 6 * Neuts$CytoTRACE2_Score, 5), 0)

# UMAP colored by clipped potency score.
FeaturePlot(Neuts, "CytoTRACE2_Score_clipped", reduction = "umap", pt.size = 0.5) +
  scale_colour_gradientn(
    colours = rev(colors),
    na.value = "transparent",
    labels = labels,
    limits = c(-5, 0),
    name = "Potency score\n",
    guide = guide_colorbar(frame.colour = "black", ticks.colour = "black")
  ) +
  coord_cartesian(xlim = x_limits, ylim = y_limits) +
  labs(x = "UMAP1", y = "UMAP2", title = NULL) +
  theme(
    aspect.ratio = 1,
    legend.text = element_text(size = 10),
    legend.title = element_text(size = 12),
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 12),
    plot.title = element_text(size = 12, face = "bold", hjust = 0.5, margin = margin(b = 20))
  )

# ─── Clean up ─────────────────────────────────────────────────────────────────

rm(labels, colors, x_limits, y_limits)
```

### Figure 2F
```{r}
# ─── Setup ─────────────────────────────────────────────────────────────────────

# Adjust CytoTRACE2's relative score for interpretability:
# Reverse and normalize score so 1 = least mature, 0 = most mature.
Neuts$RevCytoTRACE2_Relative <- -1 * (Neuts$CytoTRACE2_Relative - 1)

# Define potency category labels and custom color scale (red = mature, blue = stem-like).
labels <- c('Differentiated', 'Unipotent', 'Oligopotent', 'Multipotent', 'Pluripotent', 'Totipotent')
colors <- c("#9E0142", "#F46D43", "#FEE08B", "#E6F598", "#66C2A5", "#5E4FA2")

# Record coordinate range to ensure consistent UMAP plotting limits.
x_limits <- range(Neuts@reductions$umap@cell.embeddings[, 1], na.rm = TRUE)
y_limits <- range(Neuts@reductions$umap@cell.embeddings[, 2], na.rm = TRUE)

# ─── Maturity Score Violin Plots ───────────────────────────────────────────────

# Compare relative maturity across neutrophil subclusters
v1 <- VlnPlot(Neuts, features = "RevCytoTRACE2_Relative", group.by = "CellType", pt.size = 0) +
  geom_boxplot(outlier.shape = NA, width = 0.1, color = "black", fill = "white", alpha = 0.5) +
  labs(x = NULL, y = "Relative Maturity", title = NULL) +
  theme(legend.position = "none")

# Compare across tissues
v2 <- VlnPlot(Neuts, features = "RevCytoTRACE2_Relative", group.by = "Tissue", pt.size = 0) +
  geom_boxplot(outlier.shape = NA, width = 0.1, color = "black", fill = "white", alpha = 0.5) +
  labs(x = NULL, y = NULL, title = NULL) +
  theme(legend.position = "none")

# Combine side-by-side
cowplot::plot_grid(v1, v2, align = "h")

# ─── Clean up ─────────────────────────────────────────────────────────────────

rm(labels, colors, x_limits, y_limits, v1, v2)
```


### Figure 2G
```{r Neutrophil Subcluster Proportions by Day and Tissue, message=FALSE, warning=FALSE}
# 1. Helper function to plot subcluster percent by day for a given tissue.
plot_subtype_by_day <- function(obj, tissue) {
  # Subset to the specified tissue.
  temp1 <- subset(obj, subset = Tissue == tissue)
  # Create a data frame of counts per Day and CellType.
  temp2 <- data.frame(table(temp1@meta.data$CellType, temp1$Day))
  
  # Rename columns and compute percentages by Day.
  temp2 <- temp2 %>%
    dplyr::rename(CellType = Var1, Day = Var2) %>%
    dplyr::group_by(Day) %>%
    dplyr::mutate(Percent = Freq / sum(Freq) * 100)
  
  # Generate stacked bar chart.
  ggplot(temp2, aes(x = Day, y = Percent, fill = CellType)) +
    geom_bar(stat = "identity", colour = "black") +
    scale_y_continuous(breaks = seq(0, 100, 20), limits = c(0, 100.00001), expand = c(0, 0)) +
    theme(
      text = element_text(size = 20, colour = "black"),
      axis.text.x = element_text(size = 20, colour = "black"),
      axis.text.y = element_text(size = 20, colour = "black"),
      axis.line.x = element_blank(),
      axis.ticks.x = element_blank(),
      axis.line.y = element_line(size = 1, colour = "black", linetype = 1),
      axis.ticks.length.y = unit(0.25, "cm"),
      axis.ticks.y = element_line(size = 1, colour = "black"),
      plot.background = element_rect(fill = "transparent", colour = NA),
      panel.background = element_rect(fill = "transparent", colour = NA)
    )
}

# 2. Generate plots for each tissue with titles.
SB_lung   <- plot_subtype_by_day(Neuts, "Lung")   + ggtitle("Lung")
SB_spleen <- plot_subtype_by_day(Neuts, "Spleen") + ggtitle("Spleen")
SB_scaf   <- plot_subtype_by_day(Neuts, "Scaffold") + ggtitle("Scaffold")

# 3. Combine the three stacked bar charts side-by-side.
SB_spleen + theme(legend.position = "none", axis.title.x = element_blank()) +
  SB_lung +   theme(legend.position = "none", legend.title = element_blank(), axis.title.y = element_blank()) +
  SB_scaf +   theme(axis.title.y = element_blank(), axis.title.x = element_blank(), legend.position = "right")

# Clean up helper function and plot objects.
rm(plot_subtype_by_day, SB_spleen, SB_lung, SB_scaf)



```

### Figure 2H
```{r}
# 4. Prepare data to compare subcluster proportions across tissues.
# Subsample each tissue for equal representation.
t1 <- subset(Neuts, subset = Tissue == "Spleen", downsample = 1000); Idents(t1) <- "tissue"
t2 <- subset(Neuts, subset = Tissue == "Lung", downsample = 1000);   Idents(t2) <- "tissue"
t3 <- subset(Neuts, subset = Tissue == "Scaffold", downsample = 1000); Idents(t3) <- "tissue"

# Merge subsampled objects.
t4 <- merge(t1, list(t2, t3))

# Filter to subclusters P1–P4 only and tabulate counts by Tissue.
temp1 <- subset(t4, subset = CellType %in% c("P1", "P2", "P3", "P4_1", "P4_2"))
temp2 <- data.frame(table(temp1@meta.data$CellType, temp1@meta.data$Tissue))
temp2 <- subset(temp2, Var1 != "P0")  # Exclude P0 if present.

# Rename columns, compute percentages by CellType, and set factor levels.
temp2 <- temp2 %>%
  dplyr::rename(CellType = Var1, Tissue = Var2) %>%
  dplyr::group_by(CellType) %>%
  dplyr::mutate(Percent = Freq / sum(Freq) * 100)
temp2$CellType <- factor(temp2$CellType, levels = c("P1", "P2", "P3", "P4_1", "P4_2"))

# 5. Flipped bar chart: subcluster distribution across tissues.
ggplot(temp2, aes(x = CellType, y = Percent, fill = Tissue)) +
  geom_bar(stat = "identity", colour = "black") +
  coord_flip() +
  scale_y_continuous(breaks = seq(0, 100, 20), limits = c(0, 100.00001), expand = c(0, 0)) +
  scale_fill_manual(values = c("#2CA02C", "#1F77B4", "#9467BD")) +
  labs(x = NULL, y = "Percent", fill = NULL) +
  theme(
    text = element_text(size = 20, colour = "black"),
    axis.text.x = element_text(size = 15, colour = "black"),
    axis.text.y = element_text(size = 20, colour = "black"),
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.line.y = element_line(size = 1, colour = "black", linetype = 1),
    axis.ticks.length.y = unit(0.25, "cm"),
    axis.ticks.y = element_line(size = 1, colour = "black"),
    plot.background = element_rect(fill = "transparent", colour = NA),
    panel.background = element_rect(fill = "transparent", colour = NA),
    legend.position = "top",
    legend.title = element_blank(),
    plot.margin = unit(c(10, 10, 10, 10), "mm")
  )

# Clean up temporary objects.
rm(t1, t2, t3, t4, temp1, temp2)
```


# Supplemental Figures (for Publication)

### Figure S2A
```{r Neutrophil Cell Cycle Scoring & Visualization, message=FALSE, warning=FALSE}
# 1. Score cell‐cycle phases
#    - g2m.features: genes expressed during G2/M transition
#    - s.features: genes expressed during S phase
#    - set.ident = TRUE sets the active identity of each cell to its predicted phase
Neuts <- CellCycleScoring(
  Neuts,
  g2m.features = cc.genes$g2m.genes,
  s.features    = cc.genes$s.genes,
  set.ident     = TRUE
)

# 2. Plot S phase scores on UMAP
# Plot size (WxH): 500 x 450
FeaturePlot(
  Neuts,
  features  = "S.Score",
  reduction = "umap",
  pt.size   = 0.5
) +
  scale_color_gradientn(
    colours = c("lightgrey", "blue"),
    limits  = c(0, 1)
  ) +
  ggtitle("S Score")

# 3. Plot G2M phase scores on UMAP
# Plot size (WxH): 500 x 450
FeaturePlot(
  Neuts,
  features  = "G2M.Score",
  reduction = "umap",
  pt.size   = 0.5
) +
  scale_color_gradientn(
    colours = c("lightgrey", "blue"),
    limits  = c(0, 1)
  ) +
  ggtitle("G2M Score")

# 4. Restore cell identities to annotated subclusters
Neuts <- SetIdent(Neuts, value = Neuts@meta.data$CellType)
```




Neutrophil Maturation: CytoTRACE2 Visualization

This section visualizes CytoTRACE2 outputs to interpret neutrophil differentiation trajectories. It includes:
	1.	A clipped potency score UMAP,
	2.	Potency category UMAP,
	3.	Relative order score UMAP,
	4.	Maturity comparisons across subclusters and tissues.

```{r Neutrophil CytoTRACE2 Plotting, warning=FALSE, message=FALSE}
# ─── Setup ─────────────────────────────────────────────────────────────────────

# Adjust CytoTRACE2's relative score for interpretability:
# Reverse and normalize score so 1 = least mature, 0 = most mature.
Neuts$RevCytoTRACE2_Relative <- -1 * (Neuts$CytoTRACE2_Relative - 1)

# Clear previous plot-related variables.
rm(plot_list, labels, colors, x_limits, y_limits, potency_score_umap, rel_order_umap)

# Define potency category labels and custom color scale (red = mature, blue = stem-like).
labels <- c('Differentiated', 'Unipotent', 'Oligopotent', 'Multipotent', 'Pluripotent', 'Totipotent')
colors <- c("#9E0142", "#F46D43", "#FEE08B", "#E6F598", "#66C2A5", "#5E4FA2")

# Record coordinate range to ensure consistent UMAP plotting limits.
x_limits <- range(Neuts@reductions$umap@cell.embeddings[, 1], na.rm = TRUE)
y_limits <- range(Neuts@reductions$umap@cell.embeddings[, 2], na.rm = TRUE)

# ─── Clipped Potency Score UMAP ────────────────────────────────────────────────

# Invert and clip the raw CytoTRACE2 score (higher score = higher stemness).
Neuts$CytoTRACE2_Score_clipped <- -pmax(pmin(5.5 - 6 * Neuts$CytoTRACE2_Score, 5), 0)

# UMAP colored by clipped potency score.
FeaturePlot(Neuts, "CytoTRACE2_Score_clipped", reduction = "umap", pt.size = 0.5) +
  scale_colour_gradientn(
    colours = rev(colors),
    na.value = "transparent",
    labels = labels,
    limits = c(-5, 0),
    name = "Potency score\n",
    guide = guide_colorbar(frame.colour = "black", ticks.colour = "black")
  ) +
  coord_cartesian(xlim = x_limits, ylim = y_limits) +
  labs(x = "UMAP1", y = "UMAP2", title = NULL) +
  theme(
    aspect.ratio = 1,
    legend.text = element_text(size = 10),
    legend.title = element_text(size = 12),
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 12),
    plot.title = element_text(size = 12, face = "bold", hjust = 0.5, margin = margin(b = 20))
  )

# ─── Potency Category UMAP ─────────────────────────────────────────────────────

# UMAP colored by CytoTRACE2-assigned potency categories.
DimPlot(Neuts, reduction = "umap", group.by = "CytoTRACE2_Potency", label = FALSE, pt.size = 0.5) +
  scale_color_manual(
    values = colors,
    name = "Potency category",
    breaks = rev(labels)
  ) +
  coord_cartesian(xlim = x_limits, ylim = y_limits) +
  labs(x = "UMAP1", y = "UMAP2", title = NULL) +
  theme(
    aspect.ratio = 1,
    legend.text = element_text(size = 10),
    legend.title = element_text(size = 12),
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 12),
    plot.title = element_text(size = 12, face = "bold", hjust = 0.5, margin = margin(b = 20))
  )

# ─── Relative Score UMAP ───────────────────────────────────────────────────────

# UMAP colored by CytoTRACE2's relative score (0 = stem-like, 1 = differentiated).
FeaturePlot(Neuts, "CytoTRACE2_Relative", reduction = "umap", pt.size = 0.5) +
  scale_colour_gradientn(
    colours = c("#000004FF", "#3B0F70FF", "#8C2981FF", "#DE4968FF", "#FE9F6DFF", "#FCFDBFFF"),
    na.value = "transparent",
    limits = c(0, 1),
    breaks = seq(0, 1, by = 0.2),
    labels = c("1.0 (More diff.)", "0.8", "0.6", "0.4", "0.2", "0.0 (Less diff.)"),
    name = "Relative\norder\n",
    guide = guide_colorbar(frame.colour = "black", ticks.colour = "black")
  ) +
  coord_cartesian(xlim = x_limits, ylim = y_limits) +
  labs(x = "UMAP1", y = "UMAP2", title = NULL) +
  theme(
    aspect.ratio = 1,
    legend.text = element_text(size = 10),
    legend.title = element_text(size = 12),
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 12),
    plot.title = element_text(size = 12, face = "bold", hjust = 0.5, margin = margin(b = 20))
  )

# ─── Maturity Score Violin Plots ───────────────────────────────────────────────

# Compare relative maturity across neutrophil subclusters
v1 <- VlnPlot(Neuts, features = "RevCytoTRACE2_Relative", group.by = "CellType", pt.size = 0) +
  geom_boxplot(outlier.shape = NA, width = 0.1, color = "black", fill = "white", alpha = 0.5) +
  labs(x = NULL, y = "Relative Maturity", title = NULL) +
  theme(legend.position = "none")

# Compare across tissues
v2 <- VlnPlot(Neuts, features = "RevCytoTRACE2_Relative", group.by = "Tissue", pt.size = 0) +
  geom_boxplot(outlier.shape = NA, width = 0.1, color = "black", fill = "white", alpha = 0.5) +
  labs(x = NULL, y = NULL, title = NULL) +
  theme(legend.position = "none")

# Combine side-by-side
cowplot::plot_grid(v1, v2, align = "h")

# ─── Clean up ─────────────────────────────────────────────────────────────────

rm(plot_list, labels, colors, x_limits, y_limits, v1, v2)
```

#### Figure S3A
```{r Lung incoming signals via CellChat, warning=FALSE, message=FALSE}
# Compare outgoing/incoming signaling across lung samples
i = 1
pathway.union <- union(lungcc_object.list[[i]]@netP$pathways, 
                       c(lungcc_object.list[[i+1]]@netP$pathways, 
                       lungcc_object.list[[i+2]]@netP$pathways,
                       lungcc_object.list[[i+3]]@netP$pathways))


ht1 = netAnalysis_signalingRole_heatmap(lungcc_object.list[[i]], 
                                        pattern = "incoming", signaling = pathway.union, 
                                        title = names(lungcc_object.list)[i], width = 5, height = 20)

ht2 = netAnalysis_signalingRole_heatmap(lungcc_object.list[[i+1]], 
                                        pattern = "incoming", signaling = pathway.union, 
                                        title = names(lungcc_object.list)[i+1], width = 5, height = 20)

ht3 = netAnalysis_signalingRole_heatmap(lungcc_object.list[[i+2]], 
                                        pattern = "incoming", signaling = pathway.union, 
                                        title = names(lungcc_object.list)[i+2], width = 5, height = 20)

ht4 = netAnalysis_signalingRole_heatmap(lungcc_object.list[[i+3]], 
                                        pattern = "incoming", signaling = pathway.union, 
                                        title = names(lungcc_object.list)[i+3], width = 5, height = 20)

draw(ht1 + ht2 + ht3 + ht4, ht_gap = unit(0.5, "cm"))
rm(ht1, ht2, ht3, ht4, i, pathway.union)
```

#### Figure S3B
```{r Lung outgoing signals via CellChat, warning=FALSE, message=FALSE}
# Compare outgoing/incoming signaling across lung samples
i = 1
pathway.union <- union(lungcc_object.list[[i]]@netP$pathways, 
                       c(lungcc_object.list[[i+1]]@netP$pathways, 
                       lungcc_object.list[[i+2]]@netP$pathways,
                       lungcc_object.list[[i+3]]@netP$pathways))


ht1 = netAnalysis_signalingRole_heatmap(lungcc_object.list[[i]], 
                                        pattern = "outgoing", signaling = pathway.union, 
                                        title = names(lungcc_object.list)[i], width = 5, height = 20)

ht2 = netAnalysis_signalingRole_heatmap(lungcc_object.list[[i+1]], 
                                        pattern = "outgoing", signaling = pathway.union, 
                                        title = names(lungcc_object.list)[i+1], width = 5, height = 20)

ht3 = netAnalysis_signalingRole_heatmap(lungcc_object.list[[i+2]], 
                                        pattern = "outgoing", signaling = pathway.union, 
                                        title = names(lungcc_object.list)[i+2], width = 5, height = 20)

ht4 = netAnalysis_signalingRole_heatmap(lungcc_object.list[[i+3]], 
                                        pattern = "outgoing", signaling = pathway.union, 
                                        title = names(lungcc_object.list)[i+3], width = 5, height = 20)

draw(ht1 + ht2 + ht3 + ht4, ht_gap = unit(0.5, "cm"))
rm(ht1, ht2, ht3, ht4, i, pathway.union)
```

#### Figure S4A
```{r Scaffold incoming signals via CellChat, warning=FALSE, message=FALSE}
# Compare outgoing/incoming signaling across lung samples
i = 1
pathway.union <- union(lungcc_object.list[[i]]@netP$pathways, 
                       c(lungcc_object.list[[i+1]]@netP$pathways, 
                       lungcc_object.list[[i+2]]@netP$pathways,
                       lungcc_object.list[[i+3]]@netP$pathways))


ht1 = netAnalysis_signalingRole_heatmap(lungcc_object.list[[i]], 
                                        pattern = "incoming", signaling = pathway.union, 
                                        title = names(lungcc_object.list)[i], width = 5, height = 20)

ht2 = netAnalysis_signalingRole_heatmap(lungcc_object.list[[i+1]], 
                                        pattern = "incoming", signaling = pathway.union, 
                                        title = names(lungcc_object.list)[i+1], width = 5, height = 20)

ht3 = netAnalysis_signalingRole_heatmap(lungcc_object.list[[i+2]], 
                                        pattern = "incoming", signaling = pathway.union, 
                                        title = names(lungcc_object.list)[i+2], width = 5, height = 20)

ht4 = netAnalysis_signalingRole_heatmap(lungcc_object.list[[i+3]], 
                                        pattern = "incoming", signaling = pathway.union, 
                                        title = names(lungcc_object.list)[i+3], width = 5, height = 20)

draw(ht1 + ht2 + ht3 + ht4, ht_gap = unit(0.5, "cm"))
rm(ht1, ht2, ht3, ht4, i, pathway.union)
```

#### Figure S4B
```{r Scaffold outgoing signals via CellChat, warning=FALSE, message=FALSE}
# Compare outgoing/incoming signaling across lung samples
i = 1
pathway.union <- union(scafcc_object.list[[i]]@netP$pathways, 
                       c(scafcc_object.list[[i+1]]@netP$pathways, 
                       scafcc_object.list[[i+2]]@netP$pathways,
                       scafcc_object.list[[i+3]]@netP$pathways))

ht1 = netAnalysis_signalingRole_heatmap(scafcc_object.list[[i]], 
                                        pattern = "outgoing", signaling = pathway.union, 
                                        title = names(lungcc_object.list)[i], width = 5, height = 20)

ht2 = netAnalysis_signalingRole_heatmap(scafcc_object.list[[i+1]], 
                                        pattern = "outgoing", signaling = pathway.union, 
                                        title = names(lungcc_object.list)[i+1], width = 5, height = 20)

ht3 = netAnalysis_signalingRole_heatmap(scafcc_object.list[[i+2]], 
                                        pattern = "outgoing", signaling = pathway.union, 
                                        title = names(lungcc_object.list)[i+2], width = 5, height = 20)

ht4 = netAnalysis_signalingRole_heatmap(scafcc_object.list[[i+3]], 
                                        pattern = "outgoing", signaling = pathway.union, 
                                        title = names(lungcc_object.list)[i+3], width = 5, height = 20)

draw(ht1 + ht2 + ht3 + ht4, ht_gap = unit(0.5, "cm"))
rm(ht1, ht2, ht3, ht4, i, pathway.union)
```





#### Figure S7
```{r Scaffold CellChat circle plot through time}
weight.max <- getMaxWeight(scafcc_object.list, attribute = c("idents","count"))

# Plot size (WxH): 1400 x 700
par(mfrow = c(1,4), xpd=TRUE)
for (i in 1:4) {
  netVisual_circle(scafcc_object.list[[i]]@net$count, 
                 weight.scale = T, label.edge= F, edge.weight.max = weight.max[2], 
                 edge.width.max = 10, arrow.size = 0.05, 
                 title.name = paste0(""))
}
par(mfrow = c(1,1), xpd=TRUE)

rm(weight.max)
```

#### Figure S7B
```{r Scaffold major sources and targets, message=FALSE, warning=FALSE}
# Compare the major sources and targets
num.link <- sapply(scafcc_object.list, function(x) {rowSums(x@net$count) + colSums(x@net$count)-diag(x@net$count)})
weight.MinMax <- c(min(num.link), max(num.link)) # control the dot size in the different datasets

plot_list <- list()

for (i in 1:4){
  plot_list[[i]] <- netAnalysis_signalingRole_scatter(scafcc_object.list[[i]], weight.MinMax = weight.MinMax) + 
    ylim(0, 2.8) + xlim(0, 6) + 
    theme(axis.line = element_line(color = "black", size = 2), 
          axis.text = element_text(color = "black", size = 12), 
          axis.title = element_text(color = "black", size = 12, face = "bold"), 
          plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "cm"), 
          legend.position = "none") + 
  ylim(0, 2.8) + xlim(0, 6)
}

# Plot size (WxH): 1200 x 350
cowplot::plot_grid(plot_list[[1]], plot_list[[2]], plot_list[[3]], plot_list[[4]], align = "h", ncol = 4)

rm(num.link, weight.MinMax, plot_list)
```

#### Figure S7C
```{r Scaffold ECM signaling through time, warning=FALSE, message=FALSE}
# COLLAGEN Signaling
pathways.show <- c("COLLAGEN")
gt1 = netVisual_heatmap(scafcc_object.list[[1]], signaling = pathways.show, color.heatmap = "Reds",
                        title = names(lungcc_object.list)[1], font.size = 13, font.size.title = 0, 
                        remove.isolate = F) # Day 0

gt2 = netVisual_heatmap(scafcc_object.list[[2]], signaling = pathways.show, color.heatmap = "Reds", 
                        title = names(lungcc_object.list)[2], font.size = 13, font.size.title = 0, 
                        remove.isolate = F) # Day 7

gt3 = netVisual_heatmap(scafcc_object.list[[3]], signaling = pathways.show, color.heatmap = "Reds", 
                        title = names(lungcc_object.list)[3], font.size = 13, font.size.title = 0, 
                        remove.isolate = F) # Day 14

gt4 = netVisual_heatmap(scafcc_object.list[[4]], signaling = pathways.show, color.heatmap = "Reds", 
                        title = names(lungcc_object.list)[4], font.size = 13, font.size.title = 0, 
                        remove.isolate = F) # Day 21

# Plot size (WxH): 1400 x 450
gt1 + gt2 + gt3 + gt4

# LAMININ Signaling
pathways.show <- c("LAMININ")
gt1 = netVisual_heatmap(scafcc_object.list[[1]], signaling = pathways.show, color.heatmap = "Reds",
                        title = names(lungcc_object.list)[1], font.size = 13, font.size.title = 0, 
                        remove.isolate = F) # Day 0

gt2 = netVisual_heatmap(scafcc_object.list[[2]], signaling = pathways.show, color.heatmap = "Reds", 
                        title = names(lungcc_object.list)[2], font.size = 13, font.size.title = 0, 
                        remove.isolate = F) # Day 7

gt3 = netVisual_heatmap(scafcc_object.list[[3]], signaling = pathways.show, color.heatmap = "Reds", 
                        title = names(lungcc_object.list)[3], font.size = 13, font.size.title = 0, 
                        remove.isolate = F) # Day 14

gt4 = netVisual_heatmap(scafcc_object.list[[4]], signaling = pathways.show, color.heatmap = "Reds", 
                        title = names(lungcc_object.list)[4], font.size = 13, font.size.title = 0, 
                        remove.isolate = F) # Day 21


# Plot size (WxH): 1400 x 450
gt1 + gt2 + gt3 + gt4

# FN1 Signaling
pathways.show <- c("FN1")
gt1 = netVisual_heatmap(scafcc_object.list[[1]], signaling = pathways.show, color.heatmap = "Reds",
                        title = names(lungcc_object.list)[1], font.size = 13, font.size.title = 0, 
                        remove.isolate = F) # Day 0

gt2 = netVisual_heatmap(scafcc_object.list[[2]], signaling = pathways.show, color.heatmap = "Reds", 
                        title = names(lungcc_object.list)[2], font.size = 13, font.size.title = 0, 
                        remove.isolate = F) # Day 7

gt3 = netVisual_heatmap(scafcc_object.list[[3]], signaling = pathways.show, color.heatmap = "Reds", 
                        title = names(lungcc_object.list)[3], font.size = 13, font.size.title = 0, 
                        remove.isolate = F) # Day 14

gt4 = netVisual_heatmap(scafcc_object.list[[4]], signaling = pathways.show, color.heatmap = "Reds", 
                        title = names(lungcc_object.list)[4], font.size = 13, font.size.title = 0, 
                        remove.isolate = F) # Day 21

# Plot size (WxH): 1400 x 450
gt1 + gt2 + gt3 + gt4

rm(gt1, gt2, gt3, gt4, pathways.show)
```

#### Figure S7D
```{r}
v1 <- VlnPlot(subset(Neuts, subset = Tissue %in% c("Scaffold", "Lung", "Spleen")), 
              features = "Fpr2", y.max = 5.5) + 
  theme(legend.position = "none", axis.title.x = element_blank(), 
        axis.text = element_text(color = "black", size = 15), 
        axis.title.y = element_text(color = "black", size = 15, face = "bold")) + 
  ggtitle(NULL) + ylab("Neutrophil Fpr2")

v2 <- VlnPlot(subset(AllTissue, subset = Tissue %in% c("Scaffold")), idents = "Macrophage", 
        features = "Anxa1", group.by = "Day", y.max = 5.5) + 
  theme(legend.position = "none", axis.title.x = element_blank(), 
        axis.text = element_text(color = "black", size = 15), 
        axis.title.y = element_text(color = "black", size = 15, face = "bold")) + 
  ggtitle(NULL) + ylab("Macrophage Anxa1")

# Plot size (WxH): 700 x 350
cowplot::plot_grid(v1, v2, align = "h", ncol = 2)

rm(v1, v2)
```

